<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Windows Phone Series – Using UCWA to Connect to Lync Server - Rahul Nath</title>
  <meta name="author" content="Rahul Nath">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yoursite.com/blog/windows-phone-series-using-ucwa-to-connect-to-lync-server">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Rahul Nath" type="application/atom+xml">

  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Rahul Nath</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/blog/about">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="q" value="site:yoursite.com">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Rahul Nath" />
    <meta itemprop="description" content="" />
    <meta itemprop="url" content="http://yoursite.com" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-12T15:35:08+05:30"  data-updated="true" itemprop="datePublished dateCreated">Jan 12<sup>th</sup>, 2014</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        Windows Phone Series – Using UCWA to Connect to Lync Server
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody"><p>One of the main things that makes enterprise or intranet applications more lively and connected with your business contacts, is to integrate with <a href="http://office.microsoft.com/en-in/lync/">Lync</a> (formerly Microsoft Office Communicator) and provide options to interact with them. UCWA(Unified Communications Web Api) is a REST API that exposes Lync Server and its presence capabilities, which can be used to enhance your application capabilities. This can also be used to integrate with Windows phone applications as well and will see how to get started with it here.</p>

<p>To connect to a lync server the only details that we would want is the full email address and the password – thanks to <a href="http://msdn.microsoft.com/en-us/library/office/jj900169(v=exchg.150">AutoDiscover</a>.aspx) for exchange, which makes this possible. AutoDiscover is the way to find the users home server so that we can connect to it. The url for auto discover, otherwise called the <a href="https://ucwa.lync.com/documentation/GettingStarted-RootURL">Root Url</a> can take different forms. In this sample I have assumed that it would take the below form, primarily because it works with the test domain that I was using (microsoft.com).</p>

<p>[csharp]private const string autoDiscoverUrl = &ldquo;<a href="https://lyncdiscover.">https://lyncdiscover.</a>{0}&rdquo;;[/csharp]</p>

<p>Creating a UCWA application is the starting point for every app that needs to work with UCWA.  The following steps indicated in the below diagram are to be followed to create an application.
<a href="https://ucwa.lync.com/documentation/KeyTasks-CreateApplication"><img src="https://ucwa.lync.com/assets/lync/graph/art/CreateApp.png" alt="HTTP call flow prior to creating an application in UCWA" /></a>
Issuing a get request to ‘<a href="https://lyncdiscover.microsoft.com/">https://lyncdiscover.microsoft.com/</a>’, will give the details of the home server that we need to connect to.</p>

<p>[xml]<resource xmlns="http://schemas.microsoft.com/rtc/2012/03/ucwa" rel="root" href="https://lync32.lyncweb.microsoft.com/Autodiscover/AutodiscoverService.svc/root?originalDomain=microsoft.com">
    <link rel="user" href="https://lync32.lyncweb.microsoft.com/Autodiscover/AutodiscoverService.svc/root/oauth/user?originalDomain=microsoft.com"/>
    <link rel="xframe" href="https://lync32.lyncweb.microsoft.com/Autodiscover/XFrame/XFrame.html"/>
</resource>[/xml]</p>

<p>We now need to authenticate the user with the home server.for which we need the oauth url. This can be obtained by issuing a dummy get request to the <em>user </em>url obtained above. This request will fail with an unauthorized access but also returns the url (<a href="https://lync32.lyncweb.microsoft.com/WebTicket/oauthtoken">https://lync32.lyncweb.microsoft.com/WebTicket/oauthtoken</a>) from which the token needs to be obtained</p>

<p>[plain]HTTP/1.1 401 Unauthorized
Cache-Control: no-cache
Content-Type: text/html
Server: Microsoft-IIS/7.5
WWW-Authenticate: Bearer trusted_issuers=&ldquo;00000002-0000-0ff1-ce00-000000000000@3bdbdd27-2373-4baf-9469-4b10e76564c6,00000001-0001-0000-c000-000000000000@f686d426-8d16-42db-81b7-ab578e110ccd,00000001-0000-0000-c000-000000000000@72f988bf-86f1-41af-91ab-2d7cd011db47&rdquo;, client_id=&ldquo;00000004-0000-0ff1-ce00-000000000000&rdquo;
WWW-Authenticate: MsRtcOAuth href=&ldquo;<a href="https://lync32.lyncweb.microsoft.com/WebTicket/oauthtoken">https://lync32.lyncweb.microsoft.com/WebTicket/oauthtoken</a>&rdquo;,grant_type=&ldquo;urn:microsoft.rtc:windows,urn:microsoft.rtc:passive,urn:microsoft.rtc:anonmeeting,password&rdquo;
X-MS-Server-Fqdn: 000DCO2L50FE1G.redmond.corp.microsoft.com
X-Powered-By: ASP.NET
X-Content-Type-Options: nosniff
Date: Sun, 12 Jan 2014 10:47:50 GMT
Content-Length: 1293[/plain]</p>

<p>UCWA supports Windows Authentication, Anonymous meeting and Password Authentication mechanisms to authorize the user. i am using the Password Authentication here. On successful authentication a token is returned which can be used to issue the get request on the <em>user </em>url with the token in the header.</p>

<pre><code>private void Authenticate(string authenticateUrl, string authenticateToken, string authenticateTokenType)
{
    // Make a GET request to get the ouath url
    request = new RestRequest(authenticateUrl);
    request.AddHeader("Accept", "application/json");
    if (!string.IsNullOrEmpty(userToken))
    {
        request.AddHeader("Authorization", String.Format("{0} {1}", authenticateTokenType, authenticateToken));
    }
    ucwaClient.ExecuteAsync(request, this.ParseAuthenticateResponse);
}
</code></pre>

<p>A successful request for the above returns the applications url. The applications url might be hosted on a different server in which case we would need to get a separate token for creating a new application. The host of applications url and the oauth url we got above should be same , or else we need to get a new token. When creating a new application, we add the token only if the host’s are same. Not adding this will again fail with Unauthorized exception giving us the new oauth url.</p>

<pre><code>private void CreateNewApplications(string applications)
{
    request = new RestRequest(applications, Method.POST);
    if (CheckIfSameDomain(applications, oauthUrl))
    {
        request.AddHeader("Authorization", String.Format("{0} {1}", applicationTokenType, applicationToken));
    }
    var applicationBody = @"""UserAgent"":""{0}"",""EndpointId"":""{1}"",""Culture"":""en-US""";
    request.RequestFormat = DataFormat.Xml;
    request.AddParameter(
        "application/json",
       "{" + string.Format(applicationBody, "UCWAWindowsPhoneSample", Guid.NewGuid().ToString()) + "}",
        ParameterType.RequestBody);
    request.AddHeader("Accept", "application/json");
    ucwaClient.ExecuteAsync(request, this.CreateNewApplicationsResponse);
}

private bool CheckIfSameDomain(string url1, string url2)
{
    // Check if the token is for the correct domain
    return new Uri(url1).Host == new Uri(url2).Host;
}
</code></pre>

<p>Once this is done we have successfully created an application, that can be used to do a lot more things. As for the sample I have just retrieved the user’s full name, department and title that comes as part of successfully creating an application. You can do a lot more like getting the users presence, image, contacts, join meetings and a <a href="https://ucwa.lync.com/documentation/core-features">lot more</a>.</p>

<p><a href="http://rahulpnath.com/blog/wp-content/uploads/2014/01/image.png"><img src="http://rahulpnath.com/blog/wp-content/uploads/2014/01/image_thumb.png" alt="image" /></a>   <a href="http://rahulpnath.com/blog/wp-content/uploads/2014/01/image1.png"><img src="http://rahulpnath.com/blog/wp-content/uploads/2014/01/image_thumb1.png" alt="image" /></a></p>

<p>You can find the sample <a href="https://github.com/rahulpnath/Blog/tree/master/UCWA.WindowsPhone">here</a>.Hope this helps you to build connected enterprise applications.</p>

<p><strong>PS</strong>: I have tested this only against <strong>microsoft.com</strong> domain. In case you find any issues with the domain that you are using please do put it in the comments.</p>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">rahulpnath</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-12T15:35:08+05:30"  data-updated="true" itemprop="datePublished dateCreated">Jan 12<sup>th</sup>, 2014</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/windows-phone/'>windows phone</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://yoursite.com/blog/windows-phone-series-using-ucwa-to-connect-to-lync-server/" data-via="" data-counturl="http://yoursite.com/blog/windows-phone-series-using-ucwa-to-connect-to-lync-server/" >Tweet</a>
  
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/mvvm-a-windows-phone-scenario-part-2/" title="Previous Post: MVVM – A Windows Phone Scenario – Part 2">&laquo; MVVM – A Windows Phone Scenario – Part 2</a></li>
            
            
            <li class="next"><a href="/blog/windows-phone-series-incremental-loading-multiple-data-sources-inside-a-pivot/" title="Next Post: Windows Phone Series – Incremental Loading multiple data sources inside a Pivot">Windows Phone Series – Incremental Loading multiple data sources inside a Pivot &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/knockoutjs-for-xaml-developers/">KnockoutJS for XAML Developers</a>
    
    <a class="list-group-item " href="/blog/thanks-to-everyone-who-attended-our-talk-at-microsoft-india-hyderabad/">Thanks to Everyone Who Attended Our Talk at Microsoft India, Hyderabad</a>
    
    <a class="list-group-item " href="/blog/azure-web-sites-moving-wordpress-to-cloud/">Azure Web Sites: Moving Wordpress to Cloud</a>
    
    <a class="list-group-item " href="/blog/windows-phone-series-image-caching-library-jetimageloader/">Windows Phone Series: Image Caching Library - JetImageLoader</a>
    
    <a class="list-group-item " href="/blog/review-two-months-and-counting-android-and-nexus-5/">Review: Two Months and Counting - Android and Nexus 5</a>
    
  </div>
</section>






    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2014 - Rahul Nath<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
