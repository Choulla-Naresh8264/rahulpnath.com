<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Windows Phone Series – Incremental Loading Multiple Data Sources Inside a Pivot - Rahul Nath</title>
  <meta name="author" content="Rahul Nath">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://yoursite.com/blog/windows-phone-series-incremental-loading-multiple-data-sources-inside-a-pivot">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Rahul Nath" type="application/atom+xml">

  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Rahul Nath</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/blog/about">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="q" value="site:yoursite.com">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Rahul Nath" />
    <meta itemprop="description" content="" />
    <meta itemprop="url" content="http://yoursite.com" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-21T13:25:25+05:30"  data-updated="true" itemprop="datePublished dateCreated">Jan 21<sup>st</sup>, 2014</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        Windows Phone Series – Incremental Loading Multiple Data Sources Inside a Pivot
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody"><p>We had seen on how <a href="http://rahulpnath.com/blog/windows-phone-series-incremental-loading/">incremental loading can be done in a Windows phone</a>, so that data can be fetched as user scrolls down the available data. This is important for data sources that have a large amount of data and when all of these cannot be loaded at once. I have been getting queries on how to implement this for a Pivot control ,in which each pivot item would bind with multiple data sources or endpoints.</p>

<p>An ideal example for this would be the <a href="http://developers.500px.com/">500px api</a>, where we have photos categorized into different streams and each one of them can be in a pivot item. Since we have been talking about <a href="http://rahulpnath.com/blog/tag/mvvm/">mvvm</a>, all along will implement this using MVVM.</p>

<p><a href="http://rahulpnath.com/blog/wp-content/uploads/2014/01/image7.png"><img src="http://rahulpnath.com/blog/wp-content/uploads/2014/01/image_thumb7.png" alt="image" /></a></p>

<p>In the sample application here, I have created 2 projects – PCL and Windows Phone project, just for showing the code separation that can be achieved using MVVM. The PCL can be reused with Windows 8 too to develop a similar application, with a few minor tweaks. We would see how we can incrementally load each of these pivot items as and when the user scrolls down on the list of photos.</p>

<p>In the MainViewModel, we create ViewModel’s for each of the PivotItem, which are instances of PhotoCollectionViewModel. Each of these PhotoCollectionViewModel represents a photo stream of 500px, which is defined as a static collection of string. You can add on to this the other streams available in the 500px api to have them displayed too.</p>

<p>[csharp]private static string[] photoCollections =
    {
        &ldquo;popular&rdquo;,
        &ldquo;upcoming&rdquo;,
        &ldquo;editors&rdquo;,
        &ldquo;fresh_today&rdquo;
    };</p>

<p>public List PhotoCollectionViewModels { get; set; }</p>

<p>public MainViewModel()
{
    PhotoCollectionViewModels = new List();
    foreach (var photoCollection in photoCollections)
    {
        this.PhotoCollectionViewModels.Add(new PhotoCollectionViewModel(photoCollection));
    }
}[/csharp]</p>

<p>In the PhotoCollectionViewModel, we create the url from which the data needs to be  fetched from the api, along with the api consumer key, which can be obtained by <a href="http://500px.com/settings/applications">registering an application here</a> and assign the url to a IncrementalLoader, that will take care of incrementally loading the data and returning it to the ViewModel. The url has a placeholder for the current page number(<strong><em>page={0}</em></strong>) that would be populated by the IncrementalLoader on each load.</p>

<p>The IncrementalLoader is a generic class that takes in url from which it has to load the data and returns the generic type that it is assigned to on each LoadNextPage request.</p>

<p>[csharp]public class IncrementalLoader<T> where T : class
{
    private string BaseUrl;</p>

<pre><code>private int CurrentPageNumber;

private bool isCurrentlyLoading;

private string CurrentUrl
{
    get
    {
        return string.Format(this.BaseUrl, ++this.CurrentPageNumber);
    }
}

public IncrementalLoader(string baseUrl)
{
    this.BaseUrl = baseUrl;
}

public async Task&lt;T&gt; LoadNextPage()
{
    if (this.isCurrentlyLoading)
    {
        // call in progress
        return null;
    }

    this.isCurrentlyLoading = true;
    HttpClient client = new HttpClient();

    // Add Microsoft.Bcl.Async nuget for await to work on PCL.

    var response = await client.GetStringAsync(this.CurrentUrl);
    var serializer = new DataContractJsonSerializer(typeof(T));
    var returnObject = serializer.ReadObject(new MemoryStream(Encoding.Unicode.GetBytes(response))) as T;
    this.isCurrentlyLoading = false;

    return returnObject;
}
</code></pre>

<p>}[/csharp]</p>

<p>In the Main page, the view Model is bound to a Pivot control, which has the templates specified for displaying the list of PhotoCollectionViewModels.</p>

<p>[xml]</p>

<p><Grid x:Name="ContentPanel" Grid.Row="1" >
 &lt;phone:Pivot Name=&ldquo;photoCollection&rdquo; ItemsSource=&ldquo;{Binding PhotoCollectionViewModels}&rdquo;>
 &lt;phone:Pivot.ItemTemplate>
 <DataTemplate>
 &lt;phone:LongListSelector ItemRealized=&ldquo;Photo_Loaded&rdquo; ItemsSource=&ldquo;{Binding Photos}&rdquo; IsGroupingEnabled=&ldquo;False&rdquo;>
 &lt;phone:LongListSelector.ItemTemplate>
 <DataTemplate>
 <Image Source="{Binding image_url}" Margin="10" Width="500" />
 </DataTemplate>
 &lt;/phone:LongListSelector.ItemTemplate>
 &lt;/phone:LongListSelector>
 </DataTemplate>
 &lt;/phone:Pivot.ItemTemplate>
 &lt;phone:Pivot.HeaderTemplate>
 <DataTemplate>
 <TextBlock Text="{Binding Title}" />
 </DataTemplate>
 &lt;/phone:Pivot.HeaderTemplate>
 &lt;/phone:Pivot>
</Grid></p>

<p>[/xml]</p>

<p>In the ItemRealized method of the LongListSelector, we decide on whether to load the next page of data or not, based on the current item that gets realized. We load the data if the item realized is third from the last in the current list of photos.We connect the ItemRealized method to the ViewModel code in the code behind.</p>

<pre><code>private void Photo_Loaded(object sender, ItemRealizationEventArgs e)
{
    LongListSelector longList = sender as LongListSelector;
    PhotoCollectionViewModel vm = longList.DataContext as PhotoCollectionViewModel;

    vm.LoadMorePhotos(e.Container.Content as Photo);
}




public async Task LoadMorePhotos(Photo currentPhoto)
{
    if (currentPhoto != null)
    {
        var index = this.Photos.IndexOf(currentPhoto);
        if (this.Photos.Count - 3 &gt; index)
        {
            return ;
        }
    }
    this.currentCollection = await this.incrementalLoader.LoadNextPage();

    foreach (var photo in this.currentCollection.photos)
    {
        this.Photos.Add(photo);
    }
}
</code></pre>

<p>Whenver a user scrolls on a pivot the corresponding, ItemRealized methods gets called from which we call on to the load the data for that PhotoCollectionViewModel. This way each of the pivots are incrementally loaded as required.</p>

<p>The code for this is available <a href="https://github.com/rahulpnath/Blog/tree/master/IncrementalLoading">here</a>. Make sure you register for an application in the 500px api portal to get a consumer key that needs be updated in the solution for it to run.</p>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">rahulpnath</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-01-21T13:25:25+05:30"  data-updated="true" itemprop="datePublished dateCreated">Jan 21<sup>st</sup>, 2014</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/windows-phone/'>windows phone</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://yoursite.com/blog/windows-phone-series-incremental-loading-multiple-data-sources-inside-a-pivot/" data-via="" data-counturl="http://yoursite.com/blog/windows-phone-series-incremental-loading-multiple-data-sources-inside-a-pivot/" >Tweet</a>
  
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/windows-phone-series-using-ucwa-to-connect-to-lync-server/" title="Previous Post: Windows Phone Series – Using UCWA to connect to Lync Server">&laquo; Windows Phone Series – Using UCWA to connect to Lync Server</a></li>
            
            
            <li class="next"><a href="/blog/thanks-to-everyone-who-attended-my-first-public-talk-at-ccorner-hyderabad-ug/" title="Next Post: Thanks to Everyone Who Attended My First Public Talk At C#Corner Hyderabad UG">Thanks to Everyone Who Attended My First Public Talk At C#Corner Hyderabad UG &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/knockoutjs-for-xaml-developers/">KnockoutJS for XAML Developers</a>
    
    <a class="list-group-item " href="/blog/thanks-to-everyone-who-attended-our-talk-at-microsoft-india-hyderabad/">Thanks to Everyone Who Attended Our Talk at Microsoft India, Hyderabad</a>
    
    <a class="list-group-item " href="/blog/azure-web-sites-moving-wordpress-to-cloud/">Azure Web Sites: Moving Wordpress to Cloud</a>
    
    <a class="list-group-item " href="/blog/windows-phone-series-image-caching-library-jetimageloader/">Windows Phone Series: Image Caching Library - JetImageLoader</a>
    
    <a class="list-group-item " href="/blog/review-two-months-and-counting-android-and-nexus-5/">Review: Two Months and Counting - Android and Nexus 5</a>
    
  </div>
</section>






    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2014 - Rahul Nath<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
